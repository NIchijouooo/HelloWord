import{m as e,n as l,v as a,w as t,x as o,y as c,p as s,e as n,o as r,A as i,B as d,C as m,D as u,q as f,M as p,g as b,L as g}from"./element-plus.3300f756.js";import{_ as v,u as h,v as y}from"./index.f61f902c.js";import{D as _}from"./deviceModel.7d24566f.js";import{I as F}from"./interface.868ad1a1.js";import{D}from"./Device-property.7aa68c6e.js";import{h as k,i as x}from"./@element-plus.0bef5fa5.js";import{K as w,f as j,k as C,af as V,o as N,c as L,u as I,a as T,P as S,S as O,X as U,T as z,n as R,Q as M,ak as q,W as P,aw as E,ax as B}from"./@vue.73d14ebc.js";import"./lodash-es.98e49362.js";import"./async-validator.fb49d0f5.js";import"./@vueuse.3d90a471.js";import"./dayjs.2790329b.js";import"./axios.765908e4.js";import"./@ctrl.b082b0c1.js";import"./@popperjs.36402333.js";import"./escape-html.e5dfadb9.js";import"./normalize-wheel-es.8aeb3683.js";import"./vue-router.43b9a342.js";import"./pinia.3f4aff4f.js";import"./vue-demi.b3a9cad9.js";import"./screenfull.7cf96174.js";import"./vue-echarts.7828944a.js";import"./resize-detector.4e96b72b.js";import"./echarts.2b8dcc79.js";import"./zrender.54f191d6.js";import"./tslib.60310f1a.js";import"./nprogress.aae2b787.js";const H=e=>(E("data-v-4566a22c"),e=e(),B(),e),A={class:"main-container"},W={key:0,class:"main"},K={class:"search-bar"},Q={class:"tool-bar"},X={class:"title-left"},G={class:"title-count"},J={style:{"margin-right":"10px"}},Y={style:{"padding-right":"20px"}},Z=H((()=>T("div",null,"无数据",-1))),$={class:"pagination"},ee={class:"dialog-content"},le={class:"dialog-footer"},ae=H((()=>T("div",{class:"el-upload__tip"},"只能上传一个文件，只支持xlsx格式文件！",-1))),te={class:"dialog-footer"};var oe=v({__name:"DeviceManage",setup(v){const E=h(),B=w({headerCellStyle:{background:y.primaryColor,color:y.fontWhiteColor,height:"54px"},cellStyle:{height:"48px"},tableMaxHeight:0,currentPage:1,pagesize:20,deviceTableData:[],screenData:[],deviceTotal:0,deviceOnline:0,dFlag:!1,dTitle:"添加设备",deviceInfo:"",deviceForm:{interfaceName:"",name:"",label:"",addr:"",tsl:""},deviceRules:{interfaceName:[{required:!0,validator:"采集接口不能为空",trigger:"blur"}],name:[{required:!0,message:"设备名称不能为空",trigger:"blur"}],label:[{required:!0,message:"设备标签不能为空",trigger:"blur"}],addr:[{required:!0,message:"通信地址不能为空",trigger:"blur"}],tsl:[{required:!0,message:"物模型不能为空",trigger:"blur"}]},deviceModelList:[],selectedDevices:[],idFlag:!0,uFlag:!1,commStatusOptions:[{label:"全部",value:"Line"},{label:"在线",value:"onLine"},{label:"离线",value:"offLine"}],sFlag:!1,screenForm:{name:"",label:"",tsl:"",commStatus:"Line",collInterfaceName:[],addr:""},interfaceList:[],interfaces:[],checkedInterfaceList:[],collDeviceObj:{}}),H=()=>{B.idFlag=!0,ce()};(()=>{const e={token:E.token,data:{}};F.getInterfaceList(e).then((e=>{e&&("0"===e.code?(B.interfaceList=e.data,B.interfaces=[],B.interfaceList.forEach((e=>{B.interfaces.push(e.collInterfaceName),B.checkedInterfaceList.push(e.collInterfaceName)})),ce()):we(e))}))})();const oe=j(null),ce=e=>{const l={token:E.token,data:{names:B.checkedInterfaceList}};F.getAllCollDevices(l).then((async l=>{console.log("getCollDevices -> res",l),l&&("0"===l.code?(B.deviceTableData=null==l.data.node?[]:l.data.node,B.screenData=B.deviceTableData,B.deviceTotal=l.data.commTotalCnt,B.deviceOnline=l.data.commSuccessCnt,1===e&&b({type:"success",message:"刷新成功！"})):we(l),await R((()=>{B.tableMaxHeight=oe.value.clientHeight-34-36-22})))}))};(()=>{const e={token:E.token,data:{}};_.getDeviceModelList(e).then((e=>{console.log("getDeviceModelList -> res",e),"0"===e.code?B.deviceModelList=e.data:we(e)}))})();const se=e=>{B.selectedDevices=e},ne=e=>{B.currentPage=e},re=C((()=>B.screenData.slice((B.currentPage-1)*B.pagesize,B.currentPage*B.pagesize))),ie=C((()=>B.screenData)),de=e=>{B.pagesize=e},me=e=>{B.dFlag=!0,B.dTitle="编辑设备",B.deviceForm={interfaceName:e.collInterfaceName,name:e.name,label:e.label,addr:e.addr,tsl:e.tsl}},ue=j(null),fe=()=>{B.dFlag=!1,ue.value.resetFields(),be()},pe=e=>{fe()},be=()=>{B.deviceForm={interfaceName:"",name:"",label:"",addr:"",tsl:""}},ge=async e=>{const l={token:E.token,data:{interfaceName:e,deviceNames:B.collDeviceObj[e]}};await F.deleteCollDevices(l).then((l=>{"0"===l.code?(l.message=e+l.message,je(l,ce)):b({type:"error",message:l.message})}))},ve=()=>{ye.value&&ye.value.submit()},he=e=>{},ye=j(null),_e=e=>{ye.value.clearFiles();const l=e[0];ye.value.handleStart(l)},Fe=e=>{console.log("beforeUpload -> file",e);let l=["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(e.type)||""!=e.name&&e.name.indexOf("xlsx")>-1;if(l){if(l){let l=new FormData;l.append("name",""),l.append("fileName",e);const a={token:E.token,contentType:"multipart/form-data",data:l};F.addDeviceFromCSV(a).then((e=>{"0"===e.code?(b.success(e.message),B.uFlag=!1,ce()):we(e)}))}}else b({type:"error",message:"文件格式不正确,必须是xlsx文件！"})},De=()=>{B.uFlag=!1,ye.value.clearFiles()},ke=()=>{De()},xe=()=>{B.screenForm={name:"",tsl:"",label:"",commStatus:"Line",collInterfaceName:[],addr:""}},we=e=>{b({type:"error",message:e.message})},je=(e,l)=>{b({type:"0"===e.code?"success":"error",message:e.message}),"0"===e.code&&l&&l()};return(v,h)=>{const y=e,_=l,w=a,j=t,C=o,R=c,be=s,Ce=V("Icon"),Ve=n,Ne=r,Le=i,Ie=d,Te=m,Se=u,Oe=f,Ue=p;return N(),L("div",A,[I(B).idFlag?(N(),L("div",W,[T("div",K,[S(Ne,{model:I(B).screenForm,inline:!0,ref:"searchFormRef","status-icon":"","label-width":"90px"},{default:O((()=>[S(_,{label:"设备名称",prop:"name"},{default:O((()=>[S(y,{type:"text",modelValue:I(B).screenForm.name,"onUpdate:modelValue":h[0]||(h[0]=e=>I(B).screenForm.name=e),autocomplete:"off",placeholder:"请输入设备名称"},null,8,["modelValue"])])),_:1}),S(_,{label:"设备标签",prop:"label"},{default:O((()=>[S(y,{type:"text",modelValue:I(B).screenForm.label,"onUpdate:modelValue":h[1]||(h[1]=e=>I(B).screenForm.label=e),autocomplete:"off",placeholder:"请输入设备标签"},null,8,["modelValue"])])),_:1}),S(_,{label:"设备地址",prop:"addr"},{default:O((()=>[S(y,{type:"text",modelValue:I(B).screenForm.addr,"onUpdate:modelValue":h[2]||(h[2]=e=>I(B).screenForm.addr=e),autocomplete:"off",placeholder:"请输入设备地址"},null,8,["modelValue"])])),_:1}),S(_,{label:"设备模型",prop:"tsl"},{default:O((()=>[S(j,{modelValue:I(B).screenForm.tsl,"onUpdate:modelValue":h[3]||(h[3]=e=>I(B).screenForm.tsl=e),clearable:"",style:{width:"100%"},placeholder:"请选择设备模型"},{default:O((()=>[(N(!0),L(M,null,q(I(B).deviceModelList,((e,l)=>(N(),z(w,{key:"dm_"+l,label:e.name,value:e.name},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),S(_,{label:"采集接口",prop:"collInterfaceName"},{default:O((()=>[S(j,{modelValue:I(B).screenForm.collInterfaceName,"onUpdate:modelValue":h[4]||(h[4]=e=>I(B).screenForm.collInterfaceName=e),clearable:"",style:{width:"100%"},placeholder:"请选择采集接口",multiple:"","collapse-tags":"","collapse-tags-tooltip":""},{default:O((()=>[(N(!0),L(M,null,q(I(B).interfaceList,((e,l)=>(N(),z(w,{key:"cin_"+l,label:e.collInterfaceName,value:e.collInterfaceName},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),S(_,{label:"通信状态"},{default:O((()=>[S(R,{modelValue:I(B).screenForm.commStatus,"onUpdate:modelValue":h[5]||(h[5]=e=>I(B).screenForm.commStatus=e)},{default:O((()=>[S(C,{label:"Line"},{default:O((()=>[P("全部")])),_:1}),S(C,{label:"onLine"},{default:O((()=>[P("在线")])),_:1}),S(C,{label:"offLine"},{default:O((()=>[P("离线")])),_:1})])),_:1},8,["modelValue"])])),_:1}),S(_,{style:{"margin-left":"20px"}},{default:O((()=>[S(be,{type:"primary",onClick:h[6]||(h[6]=e=>(console.log("doScreen ctxData.deviceTableData = ",B.deviceTableData),console.log("doScreen ctxData.screenForm = ",B.screenForm),B.screenData=[],B.deviceTotal=0,B.deviceOnline=0,void B.deviceTableData.forEach((e=>{var l=e.name.includes(B.screenForm.name),a=e.label.includes(B.screenForm.label),t=e.addr.includes(B.screenForm.addr),o=""===B.screenForm.tsl||e.tsl==B.screenForm.tsl,c=0===B.screenForm.collInterfaceName.length||B.screenForm.collInterfaceName.includes(e.collInterfaceName),s="Line"===B.screenForm.commStatus||e.commStatus.includes(B.screenForm.commStatus);l&&a&&t&&o&&c&&s&&(B.screenData.push(e),"onLine"==e.commStatus&&B.deviceOnline++,B.deviceTotal++)}))))},{default:O((()=>[P("搜索")])),_:1})])),_:1}),S(_,null,{default:O((()=>[S(be,{onClick:h[7]||(h[7]=e=>{xe()})},{default:O((()=>[P("重置")])),_:1})])),_:1}),S(_,null,{default:O((()=>[S(be,{style:{color:"#fff"},color:"#2EA554",onClick:h[8]||(h[8]=e=>{ce(1)})},{default:O((()=>[S(Ve,{class:"btn-icon"},{default:O((()=>[S(Ce,{name:"local-refresh",size:"14px",color:"#ffffff"})])),_:1}),P(" 刷新 ")])),_:1})])),_:1})])),_:1},8,["model"])]),T("div",Q,[T("div",X,[S(be,{type:"primary",bg:"",class:"right-btn",onClick:h[9]||(h[9]=e=>(B.dFlag=!0,void(B.dTitle="添加设备")))},{default:O((()=>[S(Ve,{class:"btn-icon"},{default:O((()=>[S(Ce,{name:"local-add",size:"14px",color:"#ffffff"})])),_:1}),P(" 添加 ")])),_:1}),S(be,{type:"danger",bg:"",class:"right-btn",onClick:h[10]||(h[10]=e=>{0!==B.selectedDevices.length?(B.collDeviceObj={},console.log("ctxData.selectedDevices = ",B.selectedDevices),B.selectedDevices.forEach((e=>{null==B.collDeviceObj[e.collInterfaceName]?(B.collDeviceObj[e.collInterfaceName]=[],B.collDeviceObj[e.collInterfaceName].push(e.name)):B.collDeviceObj[e.collInterfaceName].push(e.name)})),g.confirm("确定要删除这些吗?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{let e=Object.getOwnPropertyNames(B.collDeviceObj).length;for(var l in console.log("cdList",e),B.collDeviceObj)ge(l)})).catch((e=>{console.log(e),b({type:"info",message:"取消删除"})}))):b.info("请至少选择一个设备！")})},{default:O((()=>[S(Ve,{class:"btn-icon"},{default:O((()=>[S(Ce,{name:"local-delete",size:"14px",color:"#ffffff"})])),_:1}),P(" 删除 ")])),_:1}),S(be,{type:"primary",bg:"",class:"right-btn",onClick:h[11]||(h[11]=e=>(()=>{if(0!==B.selectedDevices.length){let e=0;B.selectedDevices.forEach((l=>{console.log("allCollect -> item = ",l);const a={token:E.token,data:{collInterfaceName:l.collInterfaceName,deviceName:l.name}};F.getDeviceDataReal(a).then((a=>{e++,"0"===a.code?b.success(l.label+"：采集成功！"):we(a),e===B.selectedDevices.length&&ce(1)}))}))}else b.info("请至少选择一个设备！")})())},{default:O((()=>[S(Ve,{class:"btn-icon"},{default:O((()=>[S(Ce,{name:"local-refresh",size:"14px",color:"#ffffff"})])),_:1}),P(" 批量采集 ")])),_:1})]),T("div",G,[T("div",null,[T("span",J,"设备总数："+U(I(B).deviceTotal),1),T("span",null,"在线："+U(I(B).deviceOnline),1)])]),T("div",Y,[S(be,{type:"primary",plain:"",class:"right-btn",onClick:h[12]||(h[12]=e=>{B.uFlag=!0})},{default:O((()=>[S(Ve,{class:"el-input__icon"},{default:O((()=>[S(I(k))])),_:1}),P(" 导入设备 ")])),_:1}),S(be,{type:"primary",plain:"",class:"right-btn",onClick:h[13]||(h[13]=e=>(()=>{console.log("exportDevice interfaces => ",B.interfaces);const e={token:E.token,responseType:"blob",data:{names:B.interfaces}};F.exportDevice(e).then((e=>{if(e&&"1"===e.code)return void we(e);const l=new Blob([e.blob]),a=e.fileName,t=document.createElement("a");t.download=a,t.style.display="none",t.href=URL.createObjectURL(l),document.body.appendChild(t),t.click(),URL.revokeObjectURL(t.href),document.body.removeChild(t)}))})())},{default:O((()=>[S(Ve,{class:"el-input__icon"},{default:O((()=>[S(I(x))])),_:1}),P(" 导出设备 ")])),_:1})])]),T("div",{class:"content",ref_key:"contentRef",ref:oe},[S(Te,{data:I(re),"cell-style":I(B).cellStyle,"header-cell-style":I(B).headerCellStyle,"max-height":I(B).tableMaxHeight,style:{width:"100%"},stripe:"",onSelectionChange:se,onRowDblclick:me},{empty:O((()=>[Z])),default:O((()=>[S(Le,{type:"selection",width:"55",fixed:"left"}),S(Le,{sortable:"",prop:"name",label:"设备名称",width:"auto","min-width":"160",align:"center",fixed:"left"}),S(Le,{sortable:"",prop:"label",label:"设备标签",width:"auto","min-width":"160",align:"center"}),S(Le,{sortable:"",prop:"tsl",label:"设备模型",width:"auto","min-width":"160",align:"center"}),S(Le,{sortable:"",prop:"collInterfaceName",label:"采集接口",width:"auto","min-width":"160",align:"center"}),S(Le,{sortable:"",prop:"addr",label:"通讯地址",width:"auto","min-width":"100",align:"center"}),S(Le,{sortable:"",label:"当前通信状态",width:"auto","min-width":"150",align:"center"},{default:O((e=>["onLine"===e.row.commStatus?(N(),z(Ie,{key:0,type:"success"},{default:O((()=>[P("在线")])),_:1})):(N(),z(Ie,{key:1,type:"danger"},{default:O((()=>[P("离线")])),_:1}))])),_:1}),S(Le,{sortable:"",prop:"lastCommRTC",label:"最后通信时间",width:"auto","min-width":"200",align:"center"}),S(Le,{sortable:"",prop:"commTotalCnt",label:"通信总次数",width:"auto","min-width":"150",align:"center"}),S(Le,{sortable:"",prop:"commSuccessCnt",label:"通信成功次数",width:"auto","min-width":"150",align:"center"}),S(Le,{label:"操作",width:"auto","min-width":"200",align:"center",fixed:"right"},{default:O((e=>[S(be,{onClick:l=>{return a=e.row,B.idFlag=!1,void(B.curDevice=a);var a},text:"",type:"success"},{default:O((()=>[P("查看变量")])),_:2},1032,["onClick"]),S(be,{onClick:l=>me(e.row),text:"",type:"primary"},{default:O((()=>[P("编辑")])),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data","cell-style","header-cell-style","max-height"]),T("div",$,[S(Se,{"current-page":I(B).currentPage,"page-size":I(B).pagesize,"page-sizes":[20,50,200,500],total:I(ie).length,onCurrentChange:ne,onSizeChange:de,background:"",layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"46px"}},null,8,["current-page","page-size","total"])])],512)])):(N(),z(D,{key:1,curDevice:I(B).curDevice,onChangeIdFlag:H,style:{width:"100%",height:"100%",overflow:"hidden"}},null,8,["curDevice"])),S(Oe,{modelValue:I(B).dFlag,"onUpdate:modelValue":h[21]||(h[21]=e=>I(B).dFlag=e),title:I(B).dTitle,width:"600px","before-close":pe,"close-on-click-modal":!1},{footer:O((()=>[T("span",le,[S(be,{onClick:h[19]||(h[19]=e=>fe())},{default:O((()=>[P("取消")])),_:1}),S(be,{type:"primary",onClick:h[20]||(h[20]=e=>{ue.value.validate((e=>{if(!e)return!1;{const e={token:E.token,data:B.deviceForm};B.dTitle.includes("添加")?F.addCollDevice(e).then((e=>{je(e,ce),fe()})):F.editCollDevice(e).then((e=>{je(e,ce),fe()}))}}))})},{default:O((()=>[P("保存")])),_:1})])])),default:O((()=>[T("div",ee,[S(Ne,{model:I(B).deviceForm,rules:I(B).deviceRules,ref_key:"deviceFormRef",ref:ue,"status-icon":"","label-position":"right","label-width":"100px"},{default:O((()=>[S(_,{label:"设备名称",prop:"name"},{default:O((()=>[S(y,{disabled:I(B).dTitle.includes("编辑"),type:"text",modelValue:I(B).deviceForm.name,"onUpdate:modelValue":h[14]||(h[14]=e=>I(B).deviceForm.name=e),autocomplete:"off",placeholder:"请输入设备名称"},null,8,["disabled","modelValue"])])),_:1}),S(_,{label:"设备标签",prop:"label"},{default:O((()=>[S(y,{type:"text",modelValue:I(B).deviceForm.label,"onUpdate:modelValue":h[15]||(h[15]=e=>I(B).deviceForm.label=e),autocomplete:"off",placeholder:"请输入设备标签"},null,8,["modelValue"])])),_:1}),S(_,{label:"设备模型",prop:"tsl"},{default:O((()=>[S(j,{modelValue:I(B).deviceForm.tsl,"onUpdate:modelValue":h[16]||(h[16]=e=>I(B).deviceForm.tsl=e),style:{width:"100%"},placeholder:"请选择设备模型"},{default:O((()=>[(N(!0),L(M,null,q(I(B).deviceModelList,((e,l)=>(N(),z(w,{key:"dm_"+l,label:e.name,value:e.name},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),S(_,{label:"采集接口",prop:"interfaceName"},{default:O((()=>[S(j,{modelValue:I(B).deviceForm.interfaceName,"onUpdate:modelValue":h[17]||(h[17]=e=>I(B).deviceForm.interfaceName=e),clearable:"",style:{width:"100%"},placeholder:"请选择采集接口"},{default:O((()=>[(N(!0),L(M,null,q(I(B).interfaceList,((e,l)=>(N(),z(w,{key:"in_"+l,label:e.collInterfaceName,value:e.collInterfaceName},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),S(_,{label:"通讯地址",prop:"addr"},{default:O((()=>[S(y,{type:"text",modelValue:I(B).deviceForm.addr,"onUpdate:modelValue":h[18]||(h[18]=e=>I(B).deviceForm.addr=e),autocomplete:"off",placeholder:"请输入通讯地址"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])])),_:1},8,["modelValue","title"]),S(Oe,{modelValue:I(B).uFlag,"onUpdate:modelValue":h[22]||(h[22]=e=>I(B).uFlag=e),title:"上传设备xlsx文件",width:"600px","before-close":ke,"close-on-click-modal":!1},{footer:O((()=>[T("span",te,[S(be,{onClick:De},{default:O((()=>[P("取消")])),_:1}),S(be,{type:"primary",onClick:ve},{default:O((()=>[P("上传")])),_:1})])])),default:O((()=>[S(Ue,{ref_key:"uploadRef",ref:ye,action:"","auto-upload":!1,"http-request":he,limit:1,"on-exceed":_e,"before-upload":Fe},{tip:O((()=>[ae])),default:O((()=>[S(be,{type:"primary"},{default:O((()=>[P("选择文件")])),_:1})])),_:1},512)])),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-4566a22c"]]);export{oe as default};
